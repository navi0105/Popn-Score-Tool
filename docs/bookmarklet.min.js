(function () { 'use strict'; var GAME_BASE = '/game/popn/jamfizz'; var MAX_LEVEL = 50; var PAGE_DELAY = 400; var DETAIL_DELAY = 300; var isRunning = false; var stopRequested = false; var collectedData = { player: null, scores: [], exportedAt: null, }; var MEDAL_MAP = { 'meda_none': 'no_play', 'meda_k': 'easy_clear', 'meda_j': 'failed_1', 'meda_i': 'failed_2', 'meda_h': 'failed_3', 'meda_g': 'normal_clear', 'meda_f': 'normal_clear_in_20_bad', 'meda_e': 'normal_clear_in_5_bad', 'meda_d': 'full_combo', 'meda_c': 'full_combo_in_20_good', 'meda_b': 'full_combo_in_5_good', 'meda_a': 'perfect', }; var RANK_MAP = { 'rank_none': null, 'rank_e': 'E', 'rank_d': 'D', 'rank_c': 'C', 'rank_b': 'B', 'rank_a1': 'A', 'rank_a2': 'AA', 'rank_a3': 'AAA', 'rank_s': 'S', }; function extractMedal(imgSrc) { if (!imgSrc) return null; var match = imgSrc.match(/medal\/(meda_[a-z_]+)\.png/); return match ? (MEDAL_MAP[match[1]] || match[1]) : null; } function extractRank(imgSrc) { if (!imgSrc) return null; var match = imgSrc.match(/medal\/(rank_[a-z0-9_]+)\.png/); return match ? (RANK_MAP[match[1]] !== undefined ? RANK_MAP[match[1]] : match[1]) : null; } function extractScore(colDiv) { var text = colDiv.textContent.trim(); if (text === '-' || text === '') return null; var num = parseInt(text.replace(/[^0-9]/g, '')); return isNaN(num) ? null : num; } function createUI() { if (document.getElementById('popnme')) { document.getElementById('popnme').remove(); } var overlay = document.createElement('div'); overlay.id = 'popnme'; overlay.innerHTML = '\ <style>\ #popnme {\ position: fixed; top: 0; left: 0; right: 0; bottom: 0;\ background: rgba(0,0,0,0.4); z-index: 99999;\ display: flex; align-items: center; justify-content: center;\ font-family: sans-serif; color: #3d2b1f;\ }\ #popnme .panel {\ background: #fef6f0; border-radius: 12px; padding: 30px;\ max-width: 520px; width: 90%;\ box-shadow: 0 4px 24px rgba(0,0,0,0.15);\ }\ #popnme h2 { margin: 0 0 4px 0; color: #e94560; }\ #popnme .subtitle { color: #907860; margin: 0 0 20px 0; font-size: 13px; }\ #popnme .msg1 { font-size: 14px; color: #2e7ed6; margin: 8px 0 4px 0; }\ #popnme .msg2 { font-size: 12px; color: #907860; margin: 0 0 8px 0; }\ #popnme .progress-bar {\ width: 100%; height: 6px; background: #ffe0d0;\ border-radius: 3px; margin: 10px 0; overflow: hidden;\ }\ #popnme .progress-fill {\ height: 100%; width: 0%; background: #e94560;\ border-radius: 3px; transition: width 0.3s;\ }\ #popnme button {\ padding: 8px 20px; border: none; border-radius: 6px;\ color: #fff; cursor: pointer; margin: 3px; font-size: 13px;\ }\ #popnme button:hover:not(:disabled) { opacity: 0.8; }\ #popnme button:disabled { opacity: 0.4; cursor: not-allowed; }\ #popnme .btn-quick { background: #e94560; }\ #popnme .btn-stop { background: #b0a090; }\ #popnme .btn-close { background: #907860; }\ #popnme .btn-export { background: #2ecc71; }\ #popnme .btn-html { background: #4a8fe7; }\ #popnme .btn-img { background: #d08a10; }\ #popnme .btn-deep { background: #b06ce0; }\ #popnme .btn-dump { background: #8b5cf6; }\ #popnme .logger {\ max-height: 180px; overflow-y: auto; font-size: 11px;\ background: #fff0ea; border: 1px solid #f0c8b0; border-radius: 6px; padding: 10px;\ color: #1ea868; font-family: monospace; margin-top: 12px;\ }\ #popnme .logger p { margin: 2px 0; }\ #popnme .mode-desc { font-size: 11px; color: #907860; margin: 4px 0 10px 0; }\ </style>\ <div class="panel">\ <h2>Pop\'n Score Tool</h2>\ <p class="subtitle">pop\'n music score exporter</p>\ <p class="msg1" id="popnme_msg1">Initializing...</p>\ <p class="msg2" id="popnme_msg2"></p>\ <div class="progress-bar"><div class="progress-fill" id="popnme_progress"></div></div>\ <div>\ <button class="btn-quick" id="popnme_btn_quick">Scrape</button>\ <!-- [DEV] Deep Scrape: hidden for v1, enable for per-song detail fetching -->\ <!-- <button class="btn-deep" id="popnme_btn_deep">Deep Scrape</button> -->\ <!-- [DEV] Export JSON: hidden for v1, enable for raw JSON export -->\ <!-- <button class="btn-export" id="popnme_btn_export" disabled>Export JSON</button> -->\ <button class="btn-html" id="popnme_btn_html" disabled>View Results</button>\ <button class="btn-img" id="popnme_btn_img" disabled>Export Image</button>\ <!-- [DEV] Dump HTML: hidden for v1, enable for raw page HTML dump -->\ <!-- <button class="btn-dump" id="popnme_btn_dump">Dump HTML</button> -->\ <button class="btn-stop" id="popnme_btn_stop" disabled>Stop</button>\ <button class="btn-close" id="popnme_btn_close">Close</button>\ </div>\ <div class="logger" id="popnme_logger"></div>\ </div>'; document.body.appendChild(overlay); document.getElementById('popnme_btn_quick').addEventListener('click', function() { startUpdate(false); }); document.getElementById('popnme_btn_html').addEventListener('click', openViewer); document.getElementById('popnme_btn_img').addEventListener('click', exportClassImage); document.getElementById('popnme_btn_stop').addEventListener('click', requestStop); document.getElementById('popnme_btn_close').addEventListener('click', function() { overlay.remove(); }); } function log(msg) { console.log('[popnme]', msg); var logger = document.getElementById('popnme_logger'); if (logger) { var p = document.createElement('p'); p.textContent = msg; logger.insertBefore(p, logger.firstChild); } } function setMsg1(msg) { var el = document.getElementById('popnme_msg1'); if (el) el.textContent = msg; } function setMsg2(msg) { var el = document.getElementById('popnme_msg2'); if (el) el.textContent = msg; } function setProgress(ratio) { var el = document.getElementById('popnme_progress'); if (el) el.style.width = (ratio * 100) + '%'; } function setButtonState(phase) { var btnQuick = document.getElementById('popnme_btn_quick'); var btnHtml = document.getElementById('popnme_btn_html'); var btnImg = document.getElementById('popnme_btn_img'); var btnStop = document.getElementById('popnme_btn_stop'); var hasData = collectedData.scores.length > 0; if (phase === 'running') { btnQuick.disabled = true; btnStop.disabled = false; btnHtml.disabled = true; btnImg.disabled = true; } else if (phase === 'done') { btnQuick.disabled = false; btnStop.disabled = true; btnHtml.disabled = false; btnImg.disabled = false; } else { btnQuick.disabled = false; btnStop.disabled = true; btnHtml.disabled = !hasData; btnImg.disabled = !hasData; } } function fetchPage(url) { return new Promise(function(resolve, reject) { var xhr = new XMLHttpRequest(); xhr.open('GET', url); xhr.onload = function () { if (this.responseURL && this.responseURL.indexOf('error.html') > 0) { var errcode = this.responseURL.slice(-1); var errors = { '1': 'Need e-amusement Basic Course', '2': 'Need to register game card', '3': 'No play data found', '4': 'e-amusement server error', '5': 'Need Premium Course', }; reject(new Error(errors[errcode] || 'Unknown eagate error')); return; } if (this.status === 200) { resolve(this.responseText); } else { reject(new Error('HTTP ' + this.status)); } }; xhr.onerror = function () { reject(new Error('Network error')); }; xhr.send(); }); } function parseHTML(html) { return new DOMParser().parseFromString(html, 'text/html'); } function delay(ms) { return new Promise(function(resolve) { setTimeout(resolve, ms); }); } function fetchImageAsDataURL(url) { return new Promise(function(resolve, reject) { var xhr = new XMLHttpRequest(); xhr.open('GET', url); xhr.responseType = 'blob'; xhr.onload = function () { if (this.status === 200) { var reader = new FileReader(); reader.onloadend = function () { resolve(reader.result); }; reader.readAsDataURL(this.response); } else { reject(new Error('HTTP ' + this.status)); } }; xhr.onerror = function () { reject(new Error('Network error')); }; xhr.send(); }); } function buildMuLvURL(lv, page) { return GAME_BASE + '/playdata/mu_lv.html?page=' + page + '&version=0&category=0&keyword=&lv=' + lv; } function parseStatusPage(doc) { var data = {}; doc.querySelectorAll('div.st_box div.item').forEach(function(itemEl) { var label = itemEl.textContent.trim().replace(/^◆/, ''); var valueEl = itemEl.nextElementSibling; if (!valueEl || !valueEl.classList.contains('item_st')) return; var img = valueEl.querySelector('img'); if (img) { data[label] = { text: valueEl.textContent.trim(), img: img.getAttribute('src') }; } else { data[label] = valueEl.textContent.trim(); } }); var charaEl = doc.querySelector('#chara'); if (charaEl) { var charaImg = charaEl.querySelector('img'); data['使用キャラクター'] = { name: charaEl.textContent.trim(), img: charaImg ? charaImg.getAttribute('src') : null, }; } var battleCells = doc.querySelectorAll('table#net_win_table tbody tr:nth-child(2) td'); if (battleCells.length >= 4) { data['battle_record'] = { '1st': parseInt(battleCells[0].textContent) || 0, '2nd': parseInt(battleCells[1].textContent) || 0, '3rd': parseInt(battleCells[2].textContent) || 0, '4th': parseInt(battleCells[3].textContent) || 0, }; } return data; } function parseMuLvPage(doc) { var entries = []; var rows = doc.querySelectorAll('ul.mu_list_table > li'); for (var i = 1; i < rows.length; i++) { var li = rows[i]; var colMusic = li.querySelector('div.col_music_lv'); if (!colMusic) continue; var titleLink = colMusic.querySelector('a'); var subDivs = colMusic.querySelectorAll('div'); var diffText = ''; var diffEl = li.querySelector('div.col_normal_lv'); if (diffEl) diffText = diffEl.textContent.trim().toLowerCase(); var levelText = ''; var levelEl = li.querySelector('div.col_hyper_lv'); if (levelEl) levelText = levelEl.textContent.trim(); var scoreCol = li.querySelector('div.col_ex_lv'); var score = null; var medalSrc = null; var rankSrc = null; if (scoreCol) { var imgs = scoreCol.querySelectorAll('img'); medalSrc = imgs[0] ? imgs[0].getAttribute('src') : null; rankSrc = imgs[1] ? imgs[1].getAttribute('src') : null; score = extractScore(scoreCol); } entries.push({ title: titleLink ? titleLink.textContent.trim() : '', detailUrl: titleLink ? titleLink.getAttribute('href') : null, genre: subDivs[0] ? subDivs[0].textContent.trim() : '', artist: subDivs[1] ? subDivs[1].textContent.trim() : '', difficulty: diffText, level: parseInt(levelText) || null, score: score, medal: extractMedal(medalSrc), rank: extractRank(rankSrc), medalImg: medalSrc, rankImg: rankSrc, }); } return entries; } function parseDetailPage(doc) { var detail = {}; var titleEl = doc.querySelector('#title'); if (titleEl) detail.title = titleEl.textContent.trim(); var artistEl = doc.querySelector('#artist'); if (artistEl) detail.artist = artistEl.textContent.trim(); var diffs = ['easy', 'normal', 'hyper', 'ex']; for (var di = 0; di < diffs.length; di++) { var diffName = diffs[di]; var tbl = doc.querySelector('div.dif_tbl#' + diffName); if (!tbl) continue; var chartDetail = {}; var medalDiv = tbl.querySelector('div.detail_medal'); if (medalDiv) { var bgStyle = medalDiv.getAttribute('style') || ''; var bgMatch = bgStyle.match(/meda_big_([a-z_]+)\.png/); if (bgMatch) { var medalKey = 'meda_' + bgMatch[1]; chartDetail.medal = MEDAL_MAP[medalKey] || medalKey; } var rankImg = medalDiv.querySelector('img'); if (rankImg) { var rankMatch = rankImg.getAttribute('src').match(/rank_big_([a-z0-9_]+)\.png/); if (rankMatch) { var rankKey = 'rank_' + rankMatch[1]; chartDetail.rank = RANK_MAP[rankKey] !== undefined ? RANK_MAP[rankKey] : rankKey; } } } var rows = tbl.querySelectorAll('table.dif_score_tbl tr'); for (var ri = 0; ri < rows.length; ri++) { var cells = rows[ri].querySelectorAll('td'); if (cells.length < 2) continue; var label = cells[0].textContent.trim(); var val = cells[1].textContent.trim(); if (val === '-' || val === '') continue; var numVal = parseInt(val.replace(/[^0-9]/g, '')); if (rows[ri].classList.contains('score') && !label) { chartDetail.score = isNaN(numVal) ? null : numVal; } else if (label === 'COOL') { chartDetail.cool = isNaN(numVal) ? null : numVal; } else if (label === 'GREAT') { chartDetail.great = isNaN(numVal) ? null : numVal; } else if (label === 'GOOD') { chartDetail.good = isNaN(numVal) ? null : numVal; } else if (label === 'BAD') { chartDetail.bad = isNaN(numVal) ? null : numVal; } else if (label.indexOf('ハイライト') >= 0) { chartDetail.highlight = isNaN(numVal) ? null : numVal; } else if (label.indexOf('プレー回数') >= 0) { chartDetail.playCount = isNaN(numVal) ? null : numVal; } else if (label.indexOf('クリア回数') >= 0) { chartDetail.clearCount = isNaN(numVal) ? null : numVal; } else if (label === 'FULL COMBO回数') { chartDetail.fcCount = isNaN(numVal) ? null : numVal; } else if (label === 'PERFECT回数') { chartDetail.perfectCount = isNaN(numVal) ? null : numVal; } } var optEl = tbl.querySelector('div.item_st'); if (optEl) { var optText = optEl.textContent.trim(); if (optText && optText.indexOf('オプション未保存') < 0) { chartDetail.options = optText.replace(/\s{2,}/g, ' ').trim(); } } detail[diffName] = chartDetail; } return detail; } function getTotalPages(doc) { var lastOption = doc.querySelector('select#s_page option:last-child'); if (lastOption) { return parseInt(lastOption.value) + 1; } return 1; } function mergeEntry(songMap, entry) { var key = entry.detailUrl || (entry.title + '|' + entry.genre); if (!songMap[key]) { songMap[key] = { title: entry.title, genre: entry.genre, artist: entry.artist, detailUrl: entry.detailUrl, charts: {}, }; } var song = songMap[key]; var diff = entry.difficulty; if (!diff) return; if (!song.charts[diff] || song.charts[diff].score === 0 || song.charts[diff].score === null) { song.charts[diff] = { level: entry.level, score: entry.score, medal: entry.medal, rank: entry.rank, medalImg: entry.medalImg, rankImg: entry.rankImg, }; } } function markUpperCharts(scores) { var groups = {}; for (var i = 0; i < scores.length; i++) { var s = scores[i]; var key = s.title + '|' + s.genre + '|' + s.artist; if (!groups[key]) groups[key] = []; groups[key].push(s); } var upperCount = 0; for (var k in groups) { if (groups[k].length !== 2) continue; var a = groups[k][0], b = groups[k][1]; var sumA = 0, sumB = 0; var diffs = ['easy', 'normal', 'hyper', 'ex']; for (var di = 0; di < diffs.length; di++) { var d = diffs[di]; if (a.charts[d]) sumA += a.charts[d].level || 0; if (b.charts[d]) sumB += b.charts[d].level || 0; } if (sumA > sumB) { a.isUpper = true; a.title = a.title + ' [UPPER]'; upperCount++; } else if (sumB > sumA) { b.isUpper = true; b.title = b.title + ' [UPPER]'; upperCount++; } } if (upperCount > 0) { log('Detected ' + upperCount + ' Upper charts'); } } async function dumpHTML() { log('Dumping raw HTML from key pages...'); setMsg1('Dumping HTML...'); var dump = {}; var pages = [ { name: 'status', url: GAME_BASE + '/playdata/index.html' }, { name: 'mu_lv_1_p0', url: buildMuLvURL(1, 0) }, { name: 'mu_lv_30_p0', url: buildMuLvURL(30, 0) }, { name: 'mu_lv_43_p0', url: buildMuLvURL(43, 0) }, { name: 'mu_lv_50_p0', url: buildMuLvURL(50, 0) }, ]; try { log('Looking for a played song detail link...'); var listHTML = await fetchPage(buildMuLvURL(43, 0)); var listDoc = parseHTML(listHTML); var entries = parseMuLvPage(listDoc); var playedEntry = null; for (var ei = 0; ei < entries.length; ei++) { if (entries[ei].score > 0 && entries[ei].detailUrl) { playedEntry = entries[ei]; break; } } if (playedEntry) { log('Found played song: ' + playedEntry.title + ' (score=' + playedEntry.score + ')'); pages.push({ name: 'mu_detail_sample', url: playedEntry.detailUrl }); } else { var firstLink = listDoc.querySelector('ul.mu_list_table > li:nth-child(2) div.col_music_lv a'); if (firstLink) { pages.push({ name: 'mu_detail_sample', url: firstLink.getAttribute('href') }); } } } catch (e) { log('Could not find detail link: ' + e.message); } for (var i = 0; i < pages.length; i++) { var page = pages[i]; try { log('<- GET ' + page.url); var html = await fetchPage(page.url); dump[page.name] = html; log(page.name + ': ' + html.length + ' bytes'); } catch (err) { dump[page.name] = 'ERROR: ' + err.message; log(page.name + ': ERROR ' + err.message); } await delay(400); } var blob = new Blob([JSON.stringify(dump, null, 2)], { type: 'application/json' }); var url = URL.createObjectURL(blob); var a = document.createElement('a'); a.href = url; a.download = 'popn_html_dump_v4_' + new Date().toISOString().slice(0, 10) + '.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); log('HTML dump saved: ' + a.download); setMsg1('HTML dump complete. ' + Object.keys(dump).length + ' pages saved.'); } function requestStop() { stopRequested = true; setMsg2('Stopping...'); } async function startUpdate(deepMode) { if (isRunning) return; isRunning = true; stopRequested = false; collectedData.scores = []; setButtonState('running'); setProgress(0); var modeLabel = deepMode ? 'Deep' : 'Quick'; log('Starting ' + modeLabel + ' scrape...'); try { setMsg1('Fetching player status...'); log('<- GET ' + GAME_BASE + '/playdata/index.html'); var statusHTML = await fetchPage(GAME_BASE + '/playdata/index.html'); collectedData.player = parseStatusPage(parseHTML(statusHTML)); log('Player: ' + (collectedData.player['プレーヤー名'] || 'OK')); var chara = collectedData.player['使用キャラクター']; if (chara && chara.img) { try { chara.imgData = await fetchImageAsDataURL(chara.img); log('Character avatar: ' + chara.name); } catch (e) { log('Could not fetch avatar: ' + e.message); } } if (stopRequested) { finish('Stopped'); return; } var songMap = {}; for (var lv = 1; lv <= MAX_LEVEL; lv++) { if (stopRequested) { finish('Stopped (lv ' + lv + ')'); return; } setMsg1(modeLabel + ': Level ' + lv + '/' + MAX_LEVEL); setProgress((lv - 1) / MAX_LEVEL); var firstURL = buildMuLvURL(lv, 0); log('<- Lv.' + lv + ' p1'); var firstHTML = await fetchPage(firstURL); var firstDoc = parseHTML(firstHTML); var totalPages = getTotalPages(firstDoc); var entries = parseMuLvPage(firstDoc); if (entries.length === 0) { log('Lv.' + lv + ': empty, skip'); await delay(PAGE_DELAY); continue; } for (var e = 0; e < entries.length; e++) { mergeEntry(songMap, entries[e]); } for (var page = 1; page < totalPages; page++) { if (stopRequested) { finish('Stopped'); return; } await delay(PAGE_DELAY); log('<- Lv.' + lv + ' p' + (page + 1) + '/' + totalPages); var html = await fetchPage(buildMuLvURL(lv, page)); var pageEntries = parseMuLvPage(parseHTML(html)); for (var e2 = 0; e2 < pageEntries.length; e2++) { mergeEntry(songMap, pageEntries[e2]); } if (pageEntries.length === 0) break; } var currentCount = Object.keys(songMap).length; setMsg2('Lv.' + lv + ' done | ' + currentCount + ' unique songs'); log('Lv.' + lv + ': ' + totalPages + 'p, unique: ' + currentCount); await delay(PAGE_DELAY); } collectedData.scores = Object.values(songMap); markUpperCharts(collectedData.scores); var totalSongs = collectedData.scores.length; log('Quick scrape done: ' + totalSongs + ' unique songs'); if (deepMode && !stopRequested) { setMsg1('Deep: fetching song details...'); var detailCount = 0; var songsWithDetail = collectedData.scores.filter(function(s) { return s.detailUrl; }); for (var di = 0; di < songsWithDetail.length; di++) { if (stopRequested) { finish('Stopped (detail ' + di + ')'); return; } var song = songsWithDetail[di]; setMsg2('Detail ' + (di + 1) + '/' + songsWithDetail.length + ': ' + song.title); setProgress(di / songsWithDetail.length); try { log('<- detail: ' + song.title); var detailHTML = await fetchPage(song.detailUrl); song.detail = parseDetailPage(parseHTML(detailHTML)); detailCount++; } catch (err) { log('detail err (' + song.title + '): ' + err.message); song.detail = { error: err.message }; } await delay(DETAIL_DELAY); } log('Deep scrape done: ' + detailCount + ' details fetched'); } finish('Complete! ' + totalSongs + ' songs' + (deepMode ? ' (with details)' : '')); } catch (err) { log('ERROR: ' + err.message); setMsg1('Error: ' + err.message); isRunning = false; setButtonState('idle'); } } function finish(msg) { collectedData.exportedAt = new Date().toISOString(); isRunning = false; stopRequested = false; if (collectedData.scores.length > 0) { var pc = calcPopClass(collectedData.scores); collectedData.popClass = pc; setMsg1(msg + " | Pop'n Class: " + pc.value.toFixed(2) + ' (' + pc.tier + ')'); log("Pop'n Class: " + pc.value.toFixed(2) + ' (' + pc.tier + ') from ' + pc.count + ' scored charts'); } else { setMsg1(msg); } setMsg2(collectedData.scores.length + ' songs in memory'); setProgress(1); setButtonState('done'); log(msg); } var CLASS_TIERS = [ { min: 91, name: '神', color: '#d0203a' }, { min: 79, name: '仙人', color: '#c03050' }, { min: 68, name: '将軍', color: '#c08020' }, { min: 59, name: 'アイドル', color: '#b0a010' }, { min: 46, name: '刑事', color: '#209040' }, { min: 34, name: '番長', color: '#1a9080' }, { min: 21, name: '小学生', color: '#2e70c0' }, { min: 0, name: 'にゃんこ', color: '#907860' }, ]; function popClassMedalBonus(medal) { if (!medal) return 0; if (medal === 'easy_clear' || medal.indexOf('normal_clear') === 0) return 3000; if (medal.indexOf('full_combo') === 0 || medal === 'perfect') return 5000; return 0; } function calcChartClassPts(lv, score, medal) { if (!score || score < 50000) return 0; var raw = (10000 * lv + score - 50000 + popClassMedalBonus(medal)) / 5440; return Math.min(Math.floor(raw * 100) / 100, 100); } function calcPopClass(scores) { var pts = []; for (var si = 0; si < scores.length; si++) { var song = scores[si]; var charts = song.charts || {}; var diffs = ['easy', 'normal', 'hyper', 'ex']; for (var di = 0; di < diffs.length; di++) { var c = charts[diffs[di]]; if (!c) continue; var p = calcChartClassPts(c.level || 0, c.score || 0, c.medal); if (p > 0) pts.push(p); } } pts.sort(function(a, b) { return b - a; }); var top50 = pts.slice(0, 50); if (top50.length === 0) return { value: 0, tier: 'にゃんこ', count: 0 }; var avg = 0; for (var i = 0; i < top50.length; i++) avg += top50[i]; avg = Math.floor((avg / Math.min(top50.length, 50)) * 100) / 100; var tier = 'にゃんこ'; for (var ti = 0; ti < CLASS_TIERS.length; ti++) { if (avg >= CLASS_TIERS[ti].min) { tier = CLASS_TIERS[ti].name; break; } } return { value: avg, tier: tier, count: pts.length }; } function exportJSON() { var exportData = { player: collectedData.player, scores: collectedData.scores, exportedAt: collectedData.exportedAt, }; var json = JSON.stringify(exportData, null, 2); var blob = new Blob([json], { type: 'application/json' }); var url = URL.createObjectURL(blob); var a = document.createElement('a'); a.href = url; a.download = 'popn_scores_' + new Date().toISOString().slice(0, 10) + '.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); log('Exported JSON: ' + a.download); } var MEDAL_LABELS = { 'no_play': 'No Play', 'easy_clear': '\u7dd1\u2b24', 'failed_1': '\u7070\u2b24', 'failed_2': '\u7070\u25c6', 'failed_3': '\u7070\u2605', 'normal_clear': '\u9285\u2b24', 'normal_clear_in_20_bad': '\u9285\u25c6', 'normal_clear_in_5_bad': '\u9285\u2605', 'full_combo': '\u9280\u2b24', 'full_combo_in_20_good': '\u9280\u25c6', 'full_combo_in_5_good': '\u9280\u2605', 'perfect': '\u91d1\u2605' }; var MEDAL_COLORS = { 'no_play': '#bbb', 'easy_clear': '#2ea868', 'failed_1': '#999', 'failed_2': '#999', 'failed_3': '#999', 'normal_clear': '#b87333', 'normal_clear_in_20_bad': '#b87333', 'normal_clear_in_5_bad': '#b87333', 'full_combo': '#888', 'full_combo_in_20_good': '#888', 'full_combo_in_5_good': '#888', 'perfect': '#d4a017' }; var DIFF_COLORS = { easy: '#1ea868', normal: '#2e7ed6', hyper: '#d08a10', ex: '#d04030' }; function exportClassImage() { if (collectedData.scores.length === 0) return; var chartPts = []; for (var si = 0; si < collectedData.scores.length; si++) { var song = collectedData.scores[si]; var charts = song.charts || {}; var diffs = ['easy', 'normal', 'hyper', 'ex']; for (var di = 0; di < diffs.length; di++) { var c = charts[diffs[di]]; if (!c) continue; var p = calcChartClassPts(c.level || 0, c.score || 0, c.medal); if (p > 0) chartPts.push({ title: song.title, genre: song.genre, diff: diffs[di], level: c.level || 0, score: c.score || 0, medal: c.medal, rank: c.rank, pts: p }); } } chartPts.sort(function(a, b) { return b.pts - a.pts; }); var top50 = chartPts.slice(0, 50); var rowH = 28; var headerH = 40; var titleH = 60; var footerH = 30; var colGap = 16; var cols = [34, 250, 54, 34, 60, 50, 60]; var tableW = 0; for (var ci = 0; ci < cols.length; ci++) tableW += cols[ci]; tableW += 16; var rowCount = Math.min(top50.length, 25); var hasTwoCols = top50.length > 25; var totalW = hasTwoCols ? (tableW * 2 + colGap) : tableW; var totalH = titleH + headerH + (rowCount * rowH) + footerH; var canvas = document.createElement('canvas'); canvas.width = totalW; canvas.height = totalH; var ctx = canvas.getContext('2d'); ctx.fillStyle = '#fef6f0'; ctx.fillRect(0, 0, totalW, totalH); var pc = collectedData.popClass || { value: 0, tier: 'にゃんこ' }; var tierColor = '#907860'; for (var ti2 = 0; ti2 < CLASS_TIERS.length; ti2++) { if (pc.value >= CLASS_TIERS[ti2].min) { tierColor = CLASS_TIERS[ti2].color; break; } } ctx.fillStyle = tierColor; ctx.font = 'bold 24px Segoe UI, sans-serif'; ctx.fillText("Pop'n Score Tool", 10, 30); var titleRight = 10 + ctx.measureText("Pop'n Score Tool").width + 16; var chara = collectedData.player && collectedData.player['\u4f7f\u7528\u30ad\u30e3\u30e9\u30af\u30bf\u30fc']; var avatarSize = 36; var hasAvatar = chara && chara.imgData; var textLeft = hasAvatar ? titleRight + avatarSize + 8 : titleRight; ctx.fillStyle = '#3d2b1f'; ctx.font = '16px Segoe UI, sans-serif'; var playerName = (collectedData.player && collectedData.player['\u30d7\u30ec\u30fc\u30e4\u30fc\u540d']) || ''; ctx.fillText(playerName + " Pop'n Class: " + pc.value.toFixed(2) + ' (' + pc.tier + ')', textLeft, 30); ctx.fillStyle = '#907860'; ctx.font = '11px Segoe UI, sans-serif'; ctx.fillText('Top 50 Charts', textLeft, 48); var headers = ['#', 'Genre / Title', 'Diff', 'Lv', 'Score', 'Medal', 'Pts']; function drawTable(startIdx, endIdx, offsetX) { var y = titleH; ctx.fillStyle = '#ffe0d0'; ctx.fillRect(offsetX, y, tableW, headerH); ctx.fillStyle = '#907860'; ctx.font = 'bold 12px Segoe UI, sans-serif'; var x = offsetX + 8; for (var hi = 0; hi < headers.length; hi++) { ctx.fillText(headers[hi], x, y + 26); x += cols[hi]; } y += headerH; ctx.font = '12px Segoe UI, sans-serif'; for (var ri = startIdx; ri < endIdx; ri++) { var c = top50[ri]; if ((ri - startIdx) % 2 === 0) { ctx.fillStyle = '#fff0ea'; ctx.fillRect(offsetX, y, tableW, rowH); } x = offsetX + 8; ctx.fillStyle = '#907860'; ctx.fillText((ri + 1).toString(), x, y + 19); x += cols[0]; ctx.fillStyle = '#3d2b1f'; var baseTitle = c.title.replace(/ \[UPPER\]$/, ''); var t = (!c.genre || c.genre === baseTitle) ? c.title : (c.genre + ' / ' + c.title); if (t.length > 28) t = t.substring(0, 26) + '...'; ctx.fillText(t, x, y + 19); x += cols[1]; ctx.fillStyle = DIFF_COLORS[c.diff] || '#3d2b1f'; ctx.fillText(c.diff.toUpperCase(), x, y + 19); x += cols[2]; ctx.fillStyle = '#3d2b1f'; ctx.fillText(c.level.toString(), x, y + 19); x += cols[3]; ctx.fillText(c.score > 0 ? c.score.toString() : '-', x, y + 19); x += cols[4]; ctx.fillStyle = MEDAL_COLORS[c.medal] || '#907860'; ctx.fillText(MEDAL_LABELS[c.medal] || c.medal || '-', x, y + 19); x += cols[5]; ctx.fillStyle = '#e94560'; ctx.fillText(c.pts.toFixed(2), x, y + 19); y += rowH; } } drawTable(0, Math.min(top50.length, 25), 0); if (hasTwoCols) { drawTable(25, top50.length, tableW + colGap); } ctx.fillStyle = '#907860'; ctx.font = '10px Segoe UI, sans-serif'; ctx.fillText("Generated by Pop'n Score Tool | " + (collectedData.exportedAt || ''), 10, totalH - 10); function doDownload() { var link = document.createElement('a'); link.download = 'popn_class_top50.png'; link.href = canvas.toDataURL('image/png'); document.body.appendChild(link); link.click(); document.body.removeChild(link); log("Exported Pop'n Class image"); } if (hasAvatar) { var avatarImg = new Image(); avatarImg.onload = function() { ctx.drawImage(avatarImg, titleRight, 12, avatarSize, avatarSize); doDownload(); }; avatarImg.onerror = doDownload; avatarImg.src = chara.imgData; } else { doDownload(); } } var VIEWER_TEMPLATE = '<!DOCTYPE html>\n<html lang="ja">\n<head>\n<meta charset="UTF-8">\n<meta name="viewport" content="width=device-width, initial-scale=1.0">\n<title>Pop\'n Score Tool</title>\n<style>\n:root {\n--bg: #fef6f0;\n--bg2: #fff0ea;\n--bg3: #ffe0d0;\n--border: #f0c8b0;\n--text: #3d2b1f;\n--text2: #907860;\n--accent: #e94560;\n--accent2: #2ecc71;\n--blue: #4a8fe7;\n--purple: #b06ce0;\n--yellow: #e0900a;\n--easy: #1ea868;\n--normal: #2e7ed6;\n--hyper: #d08a10;\n--ex: #d04030;\n}\n* { margin: 0; padding: 0; box-sizing: border-box; }\nbody {\nfont-family: \'Segoe UI\', \'Noto Sans JP\', sans-serif;\nbackground: var(--bg);\ncolor: var(--text);\nline-height: 1.5;\n}\n.container { max-width: 1200px; margin: 0 auto; padding: 20px; }\nh1 { color: var(--accent); font-size: 28px; }\nh2 { color: var(--text); font-size: 18px; margin: 0 0 12px 0; border-bottom: 1px solid var(--border); padding-bottom: 6px; }\n/* Header / Player info */\n.header { display: flex; align-items: center; gap: 20px; margin-bottom: 24px; flex-wrap: wrap; }\n.header h1 { flex-shrink: 0; }\n.player-info { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }\n.player-info .avatar {\nwidth: 48px; height: 48px; border-radius: 8px; border: 2px solid var(--border);\nobject-fit: cover; flex-shrink: 0;\n}\n.player-info .tag {\nbackground: var(--bg3); border-radius: 6px; padding: 4px 12px;\nfont-size: 13px; color: var(--text2);\n}\n.player-info .tag b { color: var(--text); }\n/* Tabs */\n.tabs { display: flex; gap: 4px; margin-bottom: 20px; flex-wrap: wrap; }\n.tab {\npadding: 8px 20px; border: none; border-radius: 6px 6px 0 0;\nbackground: var(--bg2); color: var(--text2); cursor: pointer;\nfont-size: 14px; font-family: inherit;\n}\n.tab:hover { color: var(--text); }\n.tab.active { background: var(--bg3); color: var(--accent); border-bottom: 2px solid var(--accent); }\n.tab-panel { display: none; }\n.tab-panel.active { display: block; }\n/* Pop Class card */\n.popclass-card {\nbackground: linear-gradient(135deg, var(--bg2), var(--bg3));\nborder: 1px solid var(--border); border-radius: 12px;\npadding: 24px; margin-bottom: 24px; text-align: center;\n}\n.popclass-value { font-size: 64px; font-weight: bold; color: var(--accent); line-height: 1.1; }\n.popclass-tier { font-size: 24px; color: var(--yellow); margin: 4px 0; }\n.popclass-bar-wrap {\nwidth: 300px; max-width: 100%; height: 8px; background: var(--bg);\nborder-radius: 4px; margin: 12px auto; overflow: hidden;\n}\n.popclass-bar { height: 100%; background: var(--accent); border-radius: 4px; transition: width 0.5s; }\n.popclass-sub { font-size: 13px; color: var(--text2); }\n/* Top 50 two-column */\n.top50-section { margin-bottom: 24px; }\n.top50-flex { display: flex; gap: 20px; flex-wrap: wrap; }\n.top50-flex > div { flex: 1; min-width: 400px; }\n.export-btn {\npadding: 6px 16px; border: none; border-radius: 6px;\nbackground: var(--accent2); color: #fff; cursor: pointer;\nfont-size: 13px; font-family: inherit; margin-bottom: 12px;\n}\n.export-btn:hover { opacity: 0.8; }\n/* Tables */\ntable.data-table {\nwidth: 100%; border-collapse: collapse; font-size: 13px;\nbackground: var(--bg2); border-radius: 8px; overflow: hidden;\n}\ntable.data-table th {\nbackground: var(--bg3); padding: 8px 10px; text-align: left;\nfont-weight: 600; color: var(--text2); cursor: pointer; user-select: none;\nwhite-space: nowrap; border-bottom: 1px solid var(--border);\n}\ntable.data-table th:hover { color: var(--text); }\ntable.data-table th .sort-arrow { font-size: 10px; margin-left: 4px; }\ntable.data-table td {\npadding: 6px 10px; border-bottom: 1px solid var(--border);\nwhite-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 280px;\n}\ntable.data-table tr:hover td { background: var(--bg3); }\n.diff-easy { color: var(--easy); }\n.diff-normal { color: var(--normal); }\n.diff-hyper { color: var(--hyper); }\n.diff-ex { color: var(--ex); }\n.medal-cell { font-size: 11px; }\n.score-cell { font-family: \'Consolas\', monospace; }\n/* Filters */\n.filters {\ndisplay: flex; gap: 16px; align-items: flex-start; margin-bottom: 12px;\nflex-wrap: wrap; font-size: 13px;\n}\n.filter-group { margin-bottom: 8px; }\n.filter-group .filter-label { color: var(--text2); margin-bottom: 4px; font-weight: 600; }\n.filter-group .filter-opts {\ndisplay: flex; gap: 4px; flex-wrap: wrap; align-items: center;\n}\n.filter-group .filter-opts label {\ndisplay: flex; align-items: center; gap: 2px;\nbackground: var(--bg3); border-radius: 4px; padding: 2px 8px;\ncursor: pointer; font-size: 12px; color: var(--text);\nborder: 1px solid var(--border); user-select: none;\n}\n.filter-group .filter-opts label:hover { border-color: var(--text2); }\n.filter-group .filter-opts label.checked { border-color: var(--accent); background: #fde8e8; }\n.filter-group .filter-opts input[type="checkbox"] { display: none; }\n.filter-group .toggle-link {\nfont-size: 11px; color: var(--blue); cursor: pointer; margin-left: 4px;\ntext-decoration: underline;\n}\n.filter-search {\npadding: 4px 8px; border: 1px solid var(--border); border-radius: 4px;\nbackground: var(--bg3); color: var(--text); font-size: 13px; font-family: inherit;\nwidth: 160px;\n}\n/* Clear lamp / rank stats */\n.lamp-wrap { overflow-x: auto; max-width: 100%; }\n.lamp-table th, .lamp-table td { text-align: center; padding: 4px 1px; font-size: 12px; white-space: nowrap; }\n.lamp-table { font-size: 12px; width: auto; overflow: visible; }\n.lamp-noplay { color: #bbb; }\n.lamp-failed { color: #d04040; }\n.lamp-easy-clear { color: #2ea060; }\n.lamp-clear { color: #208020; }\n.lamp-fc { color: #c0a000; }\n.lamp-perfect { color: #d050d0; }\n/* Footer */\n.footer { margin-top: 40px; padding-top: 12px; border-top: 1px solid var(--border); font-size: 11px; color: var(--text2); text-align: center; }\n/* Canvas for image export (hidden) */\n#exportCanvas { display: none; }\n</style>\n</head>\n<body>\n<div class="container">\n<!-- Header -->\n<div class="header">\n<h1>Pop\'n Score Tool</h1>\n<div class="player-info" id="playerInfo"></div>\n<button class="export-btn" id="btnDownloadHtml" style="margin-top:8px">Download HTML</button>\n</div>\n<!-- Tabs -->\n<div class="tabs" id="tabs">\n<button class="tab active" data-tab="popclass">Pop\'n Class</button>\n<button class="tab" data-tab="scores">Score Browser</button>\n<button class="tab" data-tab="lamps">Clear Lamp Stats</button>\n<button class="tab" data-tab="ranks">Rank Stats</button>\n</div>\n<!-- Pop Class Panel -->\n<div class="tab-panel active" id="panel-popclass">\n<div class="popclass-card" id="popclassCard"></div>\n<div class="top50-section">\n<h2>Top 50 Charts</h2>\n<button class="export-btn" id="btnExportImg">Export as Image</button>\n<div class="top50-flex" id="top50Flex"></div>\n</div>\n</div>\n<!-- Score Browser Panel -->\n<div class="tab-panel" id="panel-scores">\n<div class="filters" id="filtersContainer"></div>\n<div style="font-size:12px;color:var(--text2);margin-bottom:8px;" id="scoreCount"></div>\n<table class="data-table" id="scoreTable">\n<thead>\n<tr>\n<th data-sort="title">Genre / Title</th>\n<th data-sort="artist">Artist</th>\n<th data-sort="diff">Diff</th>\n<th data-sort="level">Lv</th>\n<th data-sort="score">Score</th>\n<th data-sort="medal">Medal</th>\n<th data-sort="rank">Rank</th>\n</tr>\n</thead>\n<tbody></tbody>\n</table>\n</div>\n<!-- Clear Lamp Stats Panel -->\n<div class="tab-panel" id="panel-lamps">\n<h2>Clear Lamp per Level</h2>\n<div class="lamp-wrap">\n<table class="data-table lamp-table" id="lampTable">\n<thead><tr id="lampHeader"></tr></thead>\n<tbody></tbody>\n</table>\n</div>\n</div>\n<!-- Rank Stats Panel -->\n<div class="tab-panel" id="panel-ranks">\n<h2>Rank per Level</h2>\n<div class="lamp-wrap">\n<table class="data-table lamp-table" id="rankTable">\n<thead><tr id="rankHeader"></tr></thead>\n<tbody></tbody>\n</table>\n</div>\n</div>\n<div class="footer">\nPop\'n Score Tool &mdash; generated <span id="exportDate"></span>\n</div>\n</div>\n<canvas id="exportCanvas"></canvas>\n<script>\n// === Embedded data (replaced by build script) ===\nvar DATA = {{DATA_PLACEHOLDER}};\n// === Constants ===\nvar CLASS_TIERS = [\n{ min: 91, name: \'\\u795e\', color: \'#d0203a\' },\n{ min: 79, name: \'\\u4ed9\\u4eba\', color: \'#c03050\' },\n{ min: 68, name: \'\\u5c06\\u8ecd\', color: \'#c08020\' },\n{ min: 59, name: \'\\u30a2\\u30a4\\u30c9\\u30eb\', color: \'#b0a010\' },\n{ min: 46, name: \'\\u5211\\u4e8b\', color: \'#209040\' },\n{ min: 34, name: \'\\u756a\\u9577\', color: \'#1a9080\' },\n{ min: 21, name: \'\\u5c0f\\u5b66\\u751f\', color: \'#2e70c0\' },\n{ min: 0, name: \'\\u306b\\u3083\\u3093\\u3053\', color: \'#907860\' },\n];\nvar MEDAL_ORDER = [\n\'no_play\',\n\'failed_1\', \'failed_2\', \'failed_3\',\n\'easy_clear\',\n\'normal_clear\', \'normal_clear_in_20_bad\', \'normal_clear_in_5_bad\',\n\'full_combo\', \'full_combo_in_20_good\', \'full_combo_in_5_good\',\n\'perfect\'\n];\nvar MEDAL_LABELS = {\n\'no_play\': \'No Play\', \'easy_clear\': \'\\u7dd1\\u2b24\',\n\'failed_1\': \'\\u7070\\u2b24\', \'failed_2\': \'\\u7070\\u25c6\', \'failed_3\': \'\\u7070\\u2605\',\n\'normal_clear\': \'\\u9285\\u2b24\', \'normal_clear_in_20_bad\': \'\\u9285\\u25c6\', \'normal_clear_in_5_bad\': \'\\u9285\\u2605\',\n\'full_combo\': \'\\u9280\\u2b24\', \'full_combo_in_20_good\': \'\\u9280\\u25c6\', \'full_combo_in_5_good\': \'\\u9280\\u2605\',\n\'perfect\': \'\\u91d1\\u2605\'\n};\nvar MEDAL_COLORS = {\n\'no_play\': \'#bbb\', \'easy_clear\': \'#2ea868\',\n\'failed_1\': \'#999\', \'failed_2\': \'#999\', \'failed_3\': \'#999\',\n\'normal_clear\': \'#b87333\', \'normal_clear_in_20_bad\': \'#b87333\', \'normal_clear_in_5_bad\': \'#b87333\',\n\'full_combo\': \'#888\', \'full_combo_in_20_good\': \'#888\', \'full_combo_in_5_good\': \'#888\',\n\'perfect\': \'#d4a017\'\n};\nvar DIFF_COLORS = { easy: \'#1ea868\', normal: \'#2e7ed6\', hyper: \'#d08a10\', ex: \'#d04030\' };\nvar RANK_ORDER = [\'E\', \'D\', \'C\', \'B\', \'A\', \'AA\', \'AAA\', \'S\'];\n// === Pop Class Calculation ===\nfunction medalBonus(medal) {\nif (!medal) return 0;\nif (medal === \'easy_clear\' || medal.indexOf(\'normal_clear\') === 0) return 3000;\nif (medal.indexOf(\'full_combo\') === 0 || medal === \'perfect\') return 5000;\nreturn 0;\n}\nfunction calcClassPoints(lv, score, medal) {\nif (!score || score < 50000) return 0;\nvar raw = (10000 * lv + score - 50000 + medalBonus(medal)) / 5440;\nreturn Math.min(Math.floor(raw * 100) / 100, 100);\n}\nfunction getTier(value) {\nfor (var i = 0; i < CLASS_TIERS.length; i++) {\nif (value >= CLASS_TIERS[i].min) return CLASS_TIERS[i];\n}\nreturn CLASS_TIERS[CLASS_TIERS.length - 1];\n}\nfunction getNextTier(value) {\nfor (var i = CLASS_TIERS.length - 1; i >= 0; i--) {\nif (CLASS_TIERS[i].min > value) return CLASS_TIERS[i];\n}\nreturn null;\n}\n// === Flatten scores into per-chart rows ===\nvar allCharts = [];\n(function() {\nvar scores = DATA.scores || [];\nfor (var si = 0; si < scores.length; si++) {\nvar song = scores[si];\nvar charts = song.charts || {};\nvar diffs = [\'easy\', \'normal\', \'hyper\', \'ex\'];\nfor (var di = 0; di < diffs.length; di++) {\nvar d = diffs[di];\nif (!charts[d]) continue;\nvar c = charts[d];\nallCharts.push({\ntitle: song.title,\ngenre: song.genre,\nartist: song.artist,\ndiff: d,\nlevel: c.level || 0,\nscore: c.score || 0,\nmedal: c.medal || \'no_play\',\nrank: c.rank || null,\nclassPoints: calcClassPoints(c.level || 0, c.score || 0, c.medal),\n});\n}\n}\n})();\n// === Calculate Pop Class ===\nvar top50Charts = [];\nvar popClassValue = 0;\n(function() {\nvar sorted = allCharts.slice().sort(function(a, b) { return b.classPoints - a.classPoints; });\ntop50Charts = sorted.slice(0, 50);\nvar sum = 0;\nfor (var i = 0; i < top50Charts.length; i++) sum += top50Charts[i].classPoints;\npopClassValue = top50Charts.length > 0 ? Math.floor((sum / Math.min(top50Charts.length, 50)) * 100) / 100 : 0;\n})();\n// === Render Player Info ===\n(function() {\nvar p = DATA.player || {};\nvar info = document.getElementById(\'playerInfo\');\nvar html = \'\';\nvar chara = p[\'\\u4f7f\\u7528\\u30ad\\u30e3\\u30e9\\u30af\\u30bf\\u30fc\'];\nif (chara && chara.imgData) {\nhtml += \'<img class="avatar" src="\' + chara.imgData + \'" alt="\' + esc(chara.name || \'\') + \'" title="\' + esc(chara.name || \'\') + \'">\';\n}\nvar tags = [];\nif (p[\'\\u30d7\\u30ec\\u30fc\\u30e4\\u30fc\\u540d\']) tags.push(\'<b>\' + esc(p[\'\\u30d7\\u30ec\\u30fc\\u30e4\\u30fc\\u540d\']) + \'</b>\');\nif (p[\'\\u30dd\\u30d7\\u3068\\u3082ID\']) tags.push(\'ID: \' + esc(p[\'\\u30dd\\u30d7\\u3068\\u3082ID\']));\nif (p[\'NORMAL\\u30e2\\u30fc\\u30c9\\u30d7\\u30ec\\u30fc\\u6570\']) tags.push(\'Plays: \' + esc(p[\'NORMAL\\u30e2\\u30fc\\u30c9\\u30d7\\u30ec\\u30fc\\u6570\']));\nif (p[\'\\u6700\\u7d42\\u30d7\\u30ec\\u30fc\\u65e5\\u6642\']) tags.push(\'Last: \' + esc(p[\'\\u6700\\u7d42\\u30d7\\u30ec\\u30fc\\u65e5\\u6642\']));\nhtml += tags.map(function(t) { return \'<span class="tag">\' + t + \'</span>\'; }).join(\'\');\ninfo.innerHTML = html;\ndocument.getElementById(\'exportDate\').textContent = DATA.exportedAt || \'\';\n})();\n// === Render Pop Class Card ===\n(function() {\nvar card = document.getElementById(\'popclassCard\');\nvar tier = getTier(popClassValue);\nvar next = getNextTier(popClassValue);\nvar progress = 100;\nvar progressLabel = \'MAX\';\nif (next) {\nprogress = ((popClassValue - tier.min) / (next.min - tier.min)) * 100;\nprogressLabel = \'Next: \' + next.name + \' (\' + next.min.toFixed(2) + \')\';\n}\ncard.innerHTML =\n\'<div class="popclass-value" style="color:\' + tier.color + \'">\' + popClassValue.toFixed(2) + \'</div>\' +\n\'<div class="popclass-tier" style="color:\' + tier.color + \'">\' + tier.name + \'</div>\' +\n\'<div class="popclass-bar-wrap"><div class="popclass-bar" style="width:\' + Math.min(progress, 100) + \'%;background:\' + tier.color + \'"></div></div>\' +\n\'<div class="popclass-sub">\' + progressLabel + \' | Top 50 avg of \' + allCharts.filter(function(c){return c.classPoints>0;}).length + \' scored charts</div>\';\n})();\n// === Render Top 50 Table (two columns) ===\n(function() {\nvar flex = document.getElementById(\'top50Flex\');\nvar half = Math.min(top50Charts.length, 25);\nfunction buildTable(start, end) {\nvar html = \'<table class="data-table"><thead><tr>\' +\n\'<th>#</th><th>Genre / Title</th><th>Diff</th><th>Lv</th>\' +\n\'<th>Score</th><th>Medal</th><th>Class Pts</th>\' +\n\'</tr></thead><tbody>\';\nfor (var i = start; i < end; i++) {\nvar c = top50Charts[i];\nhtml += \'<tr>\' +\n\'<td>\' + (i + 1) + \'</td>\' +\n\'<td title="\' + esc(c.artist) + \'">\' + esc(displayTitle(c.title, c.genre)) + \'</td>\' +\n\'<td class="diff-\' + c.diff + \'">\' + c.diff.toUpperCase() + \'</td>\' +\n\'<td>\' + c.level + \'</td>\' +\n\'<td class="score-cell">\' + (c.score > 0 ? c.score : \'-\') + \'</td>\' +\n\'<td class="medal-cell" style="color:\' + (MEDAL_COLORS[c.medal] || \'#555\') + \'">\' + (MEDAL_LABELS[c.medal] || c.medal) + \'</td>\' +\n\'<td class="score-cell" style="color:var(--accent)">\' + c.classPoints.toFixed(2) + \'</td>\' +\n\'</tr>\';\n}\nhtml += \'</tbody></table>\';\nreturn html;\n}\nvar leftDiv = document.createElement(\'div\');\nleftDiv.innerHTML = buildTable(0, half);\nflex.appendChild(leftDiv);\nif (top50Charts.length > 25) {\nvar rightDiv = document.createElement(\'div\');\nrightDiv.innerHTML = buildTable(25, top50Charts.length);\nflex.appendChild(rightDiv);\n}\n})();\n// === Score Browser ===\nvar scoreSort = { key: \'level\', dir: -1 };\n// Build checkbox filters\n(function() {\nvar container = document.getElementById(\'filtersContainer\');\n// Difficulty checkboxes\nvar diffGroup = document.createElement(\'div\');\ndiffGroup.className = \'filter-group\';\ndiffGroup.innerHTML = \'<div class="filter-label">Difficulty</div><div class="filter-opts" id="filterDiffOpts"></div>\';\ncontainer.appendChild(diffGroup);\nvar diffOpts = document.getElementById(\'filterDiffOpts\');\n[\'easy\',\'normal\',\'hyper\',\'ex\'].forEach(function(d) {\nvar lbl = document.createElement(\'label\');\nlbl.className = \'checked\';\nlbl.innerHTML = \'<input type="checkbox" checked data-diff="\' + d + \'"> <span class="diff-\' + d + \'">\' + d.toUpperCase() + \'</span>\';\nlbl.querySelector(\'input\').addEventListener(\'change\', function() {\nlbl.className = this.checked ? \'checked\' : \'\';\nrenderScoreTable();\n});\ndiffOpts.appendChild(lbl);\n});\n// Level checkboxes\nvar lvGroup = document.createElement(\'div\');\nlvGroup.className = \'filter-group\';\nlvGroup.innerHTML = \'<div class="filter-label">Level <span class="toggle-link" id="lvAll">All</span> <span class="toggle-link" id="lvNone">None</span></div><div class="filter-opts" id="filterLvOpts"></div>\';\ncontainer.appendChild(lvGroup);\nvar lvOpts = document.getElementById(\'filterLvOpts\');\nfor (var i = 1; i <= 50; i++) {\nvar lbl = document.createElement(\'label\');\nlbl.className = \'checked\';\nlbl.innerHTML = \'<input type="checkbox" checked data-lv="\' + i + \'"> \' + i;\nlbl.querySelector(\'input\').addEventListener(\'change\', function() {\nthis.parentElement.className = this.checked ? \'checked\' : \'\';\nrenderScoreTable();\n});\nlvOpts.appendChild(lbl);\n}\ndocument.getElementById(\'lvAll\').addEventListener(\'click\', function() {\nlvOpts.querySelectorAll(\'input\').forEach(function(cb) { cb.checked = true; cb.parentElement.className = \'checked\'; });\nrenderScoreTable();\n});\ndocument.getElementById(\'lvNone\').addEventListener(\'click\', function() {\nlvOpts.querySelectorAll(\'input\').forEach(function(cb) { cb.checked = false; cb.parentElement.className = \'\'; });\nrenderScoreTable();\n});\n// Medal checkboxes\nvar medalGroup = document.createElement(\'div\');\nmedalGroup.className = \'filter-group\';\nmedalGroup.innerHTML = \'<div class="filter-label">Medal <span class="toggle-link" id="medalAll">All</span> <span class="toggle-link" id="medalNone">None</span></div><div class="filter-opts" id="filterMedalOpts"></div>\';\ncontainer.appendChild(medalGroup);\nvar medalOpts = document.getElementById(\'filterMedalOpts\');\nMEDAL_ORDER.forEach(function(m) {\nvar lbl = document.createElement(\'label\');\nlbl.className = \'checked\';\nlbl.innerHTML = \'<input type="checkbox" checked data-medal="\' + m + \'"> <span style="color:\' + (MEDAL_COLORS[m] || \'#555\') + \'">\' + (MEDAL_LABELS[m] || m) + \'</span>\';\nlbl.querySelector(\'input\').addEventListener(\'change\', function() {\nthis.parentElement.className = this.checked ? \'checked\' : \'\';\nrenderScoreTable();\n});\nmedalOpts.appendChild(lbl);\n});\ndocument.getElementById(\'medalAll\').addEventListener(\'click\', function() {\nmedalOpts.querySelectorAll(\'input\').forEach(function(cb) { cb.checked = true; cb.parentElement.className = \'checked\'; });\nrenderScoreTable();\n});\ndocument.getElementById(\'medalNone\').addEventListener(\'click\', function() {\nmedalOpts.querySelectorAll(\'input\').forEach(function(cb) { cb.checked = false; cb.parentElement.className = \'\'; });\nrenderScoreTable();\n});\n// Search\nvar searchGroup = document.createElement(\'div\');\nsearchGroup.className = \'filter-group\';\nsearchGroup.innerHTML = \'<div class="filter-label">Search</div><input type="text" class="filter-search" id="filterSearch" placeholder="Song title...">\';\ncontainer.appendChild(searchGroup);\ndocument.getElementById(\'filterSearch\').addEventListener(\'input\', renderScoreTable);\n})();\nfunction renderScoreTable() {\nvar checkedDiffs = {};\ndocument.querySelectorAll(\'#filterDiffOpts input:checked\').forEach(function(cb) {\ncheckedDiffs[cb.getAttribute(\'data-diff\')] = true;\n});\nvar checkedLvs = {};\ndocument.querySelectorAll(\'#filterLvOpts input:checked\').forEach(function(cb) {\ncheckedLvs[parseInt(cb.getAttribute(\'data-lv\'))] = true;\n});\nvar checkedMedals = {};\ndocument.querySelectorAll(\'#filterMedalOpts input:checked\').forEach(function(cb) {\ncheckedMedals[cb.getAttribute(\'data-medal\')] = true;\n});\nvar search = document.getElementById(\'filterSearch\').value.toLowerCase();\nvar filtered = allCharts.filter(function(c) {\nif (!checkedDiffs[c.diff]) return false;\nif (!checkedLvs[c.level]) return false;\nif (!checkedMedals[c.medal]) return false;\nif (search && c.title.toLowerCase().indexOf(search) < 0 && (!c.genre || c.genre.toLowerCase().indexOf(search) < 0)) return false;\nreturn true;\n});\nfiltered.sort(function(a, b) {\nvar va = a[scoreSort.key], vb = b[scoreSort.key];\nif (scoreSort.key === \'medal\') {\nva = MEDAL_ORDER.indexOf(a.medal);\nvb = MEDAL_ORDER.indexOf(b.medal);\n}\nif (scoreSort.key === \'rank\') {\nva = a.rank ? RANK_ORDER.indexOf(a.rank) : -1;\nvb = b.rank ? RANK_ORDER.indexOf(b.rank) : -1;\n}\nif (va === vb) return 0;\nif (va === null || va === undefined) return 1;\nif (vb === null || vb === undefined) return -1;\nif (typeof va === \'string\') return va.localeCompare(vb) * scoreSort.dir;\nreturn (va - vb) * scoreSort.dir;\n});\ndocument.getElementById(\'scoreCount\').textContent = filtered.length + \' charts\';\nvar tbody = document.querySelector(\'#scoreTable tbody\');\nvar html = \'\';\nvar limit = Math.min(filtered.length, 500);\nfor (var i = 0; i < limit; i++) {\nvar c = filtered[i];\nhtml += \'<tr>\' +\n\'<td>\' + esc(displayTitle(c.title, c.genre)) + \'</td>\' +\n\'<td>\' + esc(c.artist) + \'</td>\' +\n\'<td class="diff-\' + c.diff + \'">\' + c.diff.toUpperCase() + \'</td>\' +\n\'<td>\' + c.level + \'</td>\' +\n\'<td class="score-cell">\' + (c.score > 0 ? c.score : \'-\') + \'</td>\' +\n\'<td class="medal-cell" style="color:\' + (MEDAL_COLORS[c.medal] || \'#555\') + \'">\' + (MEDAL_LABELS[c.medal] || c.medal) + \'</td>\' +\n\'<td>\' + (c.rank || \'-\') + \'</td>\' +\n\'</tr>\';\n}\nif (filtered.length > 500) {\nhtml += \'<tr><td colspan="7" style="text-align:center;color:var(--text2)">... and \' + (filtered.length - 500) + \' more</td></tr>\';\n}\ntbody.innerHTML = html;\n}\n// Sort headers\ndocument.querySelectorAll(\'#scoreTable th[data-sort]\').forEach(function(th) {\nth.addEventListener(\'click\', function() {\nvar key = this.getAttribute(\'data-sort\');\nif (scoreSort.key === key) {\nscoreSort.dir *= -1;\n} else {\nscoreSort.key = key;\nscoreSort.dir = key === \'title\' || key === \'artist\' || key === \'diff\' ? 1 : -1;\n}\ndocument.querySelectorAll(\'#scoreTable th\').forEach(function(h) {\nvar arrow = h.querySelector(\'.sort-arrow\');\nif (arrow) arrow.remove();\n});\nvar arrow = document.createElement(\'span\');\narrow.className = \'sort-arrow\';\narrow.textContent = scoreSort.dir > 0 ? \' \\u25b2\' : \' \\u25bc\';\nthis.appendChild(arrow);\nrenderScoreTable();\n});\n});\nrenderScoreTable();\n// === Clear Lamp Stats ===\n(function() {\n// Build header\nvar headerRow = document.getElementById(\'lampHeader\');\nvar headerCols = [\'Lv\', \'Total\'];\nfor (var mi = 0; mi < MEDAL_ORDER.length; mi++) {\nheaderCols.push(MEDAL_LABELS[MEDAL_ORDER[mi]]);\n}\nheaderRow.innerHTML = \'<th>\' + headerCols[0] + \'</th><th>\' + headerCols[1] + \'</th>\';\nfor (var hi = 0; hi < MEDAL_ORDER.length; hi++) {\nheaderRow.innerHTML += \'<th style="color:\' + (MEDAL_COLORS[MEDAL_ORDER[hi]] || \'#555\') + \'">\' + headerCols[hi + 2] + \'</th>\';\n}\n// Compute stats\nvar lvStats = {};\nfor (var i = 0; i < allCharts.length; i++) {\nvar c = allCharts[i];\nvar lv = c.level;\nif (!lvStats[lv]) {\nlvStats[lv] = { total: 0 };\nfor (var mi2 = 0; mi2 < MEDAL_ORDER.length; mi2++) lvStats[lv][MEDAL_ORDER[mi2]] = 0;\n}\nlvStats[lv].total++;\nif (lvStats[lv][c.medal] !== undefined) lvStats[lv][c.medal]++;\n}\nvar tbody = document.querySelector(\'#lampTable tbody\');\nvar html = \'\';\nvar levels = Object.keys(lvStats).map(Number).sort(function(a,b){return a-b;});\nvar totals = { total: 0 };\nfor (var mi4 = 0; mi4 < MEDAL_ORDER.length; mi4++) totals[MEDAL_ORDER[mi4]] = 0;\nfor (var li = 0; li < levels.length; li++) {\nvar lv = levels[li];\nvar s = lvStats[lv];\ntotals.total += s.total;\nhtml += \'<tr><td><b>\' + lv + \'</b></td><td>\' + s.total + \'</td>\';\nfor (var mi3 = 0; mi3 < MEDAL_ORDER.length; mi3++) {\nvar m = MEDAL_ORDER[mi3];\nvar count = s[m] || 0;\ntotals[m] += count;\nvar color = MEDAL_COLORS[m] || \'#555\';\nhtml += \'<td style="color:\' + color + \'">\' + (count || \'-\') + \'</td>\';\n}\nhtml += \'</tr>\';\n}\n// Total row\nhtml += \'<tr style="border-top:2px solid var(--border);font-weight:bold"><td>Total</td><td>\' + totals.total + \'</td>\';\nfor (var mi5 = 0; mi5 < MEDAL_ORDER.length; mi5++) {\nvar m2 = MEDAL_ORDER[mi5];\nvar color2 = MEDAL_COLORS[m2] || \'#555\';\nhtml += \'<td style="color:\' + color2 + \'">\' + (totals[m2] || \'-\') + \'</td>\';\n}\nhtml += \'</tr>\';\ntbody.innerHTML = html;\n})();\n// === Rank Lamp Stats ===\n(function() {\nvar RANK_DISPLAY = [null, \'E\', \'D\', \'C\', \'B\', \'A\', \'AA\', \'AAA\', \'S\'];\nvar RANK_LABELS = [\'No Play\', \'E\', \'D\', \'C\', \'B\', \'A\', \'AA\', \'AAA\', \'S\'];\n// Build header\nvar headerRow = document.getElementById(\'rankHeader\');\nheaderRow.innerHTML = \'<th>Lv</th><th>Total</th>\';\nfor (var ri = 0; ri < RANK_LABELS.length; ri++) {\nheaderRow.innerHTML += \'<th>\' + RANK_LABELS[ri] + \'</th>\';\n}\n// Compute stats\nvar lvStats = {};\nfor (var i = 0; i < allCharts.length; i++) {\nvar c = allCharts[i];\nvar lv = c.level;\nif (!lvStats[lv]) {\nlvStats[lv] = { total: 0 };\nfor (var ri2 = 0; ri2 < RANK_DISPLAY.length; ri2++) lvStats[lv][String(RANK_DISPLAY[ri2])] = 0;\n}\nlvStats[lv].total++;\nlvStats[lv][String(c.rank)]++;\n}\nvar tbody = document.querySelector(\'#rankTable tbody\');\nvar html = \'\';\nvar levels = Object.keys(lvStats).map(Number).sort(function(a,b){return a-b;});\nvar totals = { total: 0 };\nfor (var ri3 = 0; ri3 < RANK_DISPLAY.length; ri3++) totals[String(RANK_DISPLAY[ri3])] = 0;\nfor (var li = 0; li < levels.length; li++) {\nvar lv = levels[li];\nvar s = lvStats[lv];\ntotals.total += s.total;\nhtml += \'<tr><td><b>\' + lv + \'</b></td><td>\' + s.total + \'</td>\';\nfor (var ri4 = 0; ri4 < RANK_DISPLAY.length; ri4++) {\nvar count = s[String(RANK_DISPLAY[ri4])] || 0;\ntotals[String(RANK_DISPLAY[ri4])] += count;\nhtml += \'<td>\' + (count || \'-\') + \'</td>\';\n}\nhtml += \'</tr>\';\n}\n// Total row\nhtml += \'<tr style="border-top:2px solid var(--border);font-weight:bold"><td>Total</td><td>\' + totals.total + \'</td>\';\nfor (var ri5 = 0; ri5 < RANK_DISPLAY.length; ri5++) {\nhtml += \'<td>\' + (totals[String(RANK_DISPLAY[ri5])] || \'-\') + \'</td>\';\n}\nhtml += \'</tr>\';\ntbody.innerHTML = html;\n})();\n// === Tabs ===\ndocument.querySelectorAll(\'.tab\').forEach(function(tab) {\ntab.addEventListener(\'click\', function() {\ndocument.querySelectorAll(\'.tab\').forEach(function(t) { t.classList.remove(\'active\'); });\ndocument.querySelectorAll(\'.tab-panel\').forEach(function(p) { p.classList.remove(\'active\'); });\nthis.classList.add(\'active\');\ndocument.getElementById(\'panel-\' + this.getAttribute(\'data-tab\')).classList.add(\'active\');\n});\n});\n// === Image Export (two-column) ===\ndocument.getElementById(\'btnExportImg\').addEventListener(\'click\', function() {\nvar canvas = document.getElementById(\'exportCanvas\');\nvar ctx = canvas.getContext(\'2d\');\nvar rowH = 28;\nvar headerH = 40;\nvar titleH = 60;\nvar footerH = 30;\nvar colGap = 16;\nvar cols = [34, 250, 54, 34, 60, 50, 60];\nvar tableW = 0;\nfor (var ci = 0; ci < cols.length; ci++) tableW += cols[ci];\ntableW += 16;\nvar rowCount = Math.min(top50Charts.length, 25);\nvar hasTwoCols = top50Charts.length > 25;\nvar totalW = hasTwoCols ? (tableW * 2 + colGap) : tableW;\nvar totalH = titleH + headerH + (rowCount * rowH) + footerH;\ncanvas.width = totalW;\ncanvas.height = totalH;\n// Background\nctx.fillStyle = \'#fef6f0\';\nctx.fillRect(0, 0, totalW, totalH);\n// Title area\nvar tier = getTier(popClassValue);\nctx.fillStyle = tier.color;\nctx.font = \'bold 24px Segoe UI, sans-serif\';\nctx.fillText("Pop\'n Score Tool", 10, 30);\nvar titleRight = 10 + ctx.measureText("Pop\'n Score Tool").width + 16;\nvar chara = DATA.player && DATA.player[\'\\u4f7f\\u7528\\u30ad\\u30e3\\u30e9\\u30af\\u30bf\\u30fc\'];\nvar avatarSize = 36;\nvar hasAvatar = chara && chara.imgData;\nvar textLeft = hasAvatar ? titleRight + avatarSize + 8 : titleRight;\nctx.fillStyle = \'#3d2b1f\';\nctx.font = \'16px Segoe UI, sans-serif\';\nvar playerName = (DATA.player && DATA.player[\'\\u30d7\\u30ec\\u30fc\\u30e4\\u30fc\\u540d\']) || \'\';\nctx.fillText(playerName + "  Pop\'n Class: " + popClassValue.toFixed(2) + \' (\' + tier.name + \')\', textLeft, 30);\nctx.fillStyle = \'#907860\';\nctx.font = \'11px Segoe UI, sans-serif\';\nctx.fillText(\'Top 50 Charts\', textLeft, 48);\nvar headers = [\'#\', \'Genre / Title\', \'Diff\', \'Lv\', \'Score\', \'Medal\', \'Pts\'];\nfunction drawTable(startIdx, endIdx, offsetX) {\nvar y = titleH;\nctx.fillStyle = \'#ffe0d0\';\nctx.fillRect(offsetX, y, tableW, headerH);\nctx.fillStyle = \'#907860\';\nctx.font = \'bold 12px Segoe UI, sans-serif\';\nvar x = offsetX + 8;\nfor (var hi = 0; hi < headers.length; hi++) {\nctx.fillText(headers[hi], x, y + 26);\nx += cols[hi];\n}\ny += headerH;\nctx.font = \'12px Segoe UI, sans-serif\';\nfor (var ri = startIdx; ri < endIdx; ri++) {\nvar c = top50Charts[ri];\nif ((ri - startIdx) % 2 === 0) {\nctx.fillStyle = \'#fff0ea\';\nctx.fillRect(offsetX, y, tableW, rowH);\n}\nx = offsetX + 8;\nctx.fillStyle = \'#907860\';\nctx.fillText((ri + 1).toString(), x, y + 19);\nx += cols[0];\nctx.fillStyle = \'#3d2b1f\';\nvar titleText = displayTitle(c.title, c.genre);\nif (titleText.length > 28) titleText = titleText.substring(0, 26) + \'...\';\nctx.fillText(titleText, x, y + 19);\nx += cols[1];\nctx.fillStyle = DIFF_COLORS[c.diff] || \'#3d2b1f\';\nctx.fillText(c.diff.toUpperCase(), x, y + 19);\nx += cols[2];\nctx.fillStyle = \'#3d2b1f\';\nctx.fillText(c.level.toString(), x, y + 19);\nx += cols[3];\nctx.fillText(c.score > 0 ? c.score.toString() : \'-\', x, y + 19);\nx += cols[4];\nctx.fillStyle = MEDAL_COLORS[c.medal] || \'#907860\';\nctx.fillText(MEDAL_LABELS[c.medal] || c.medal, x, y + 19);\nx += cols[5];\nctx.fillStyle = \'#e94560\';\nctx.fillText(c.classPoints.toFixed(2), x, y + 19);\ny += rowH;\n}\n}\ndrawTable(0, Math.min(top50Charts.length, 25), 0);\nif (hasTwoCols) {\ndrawTable(25, top50Charts.length, tableW + colGap);\n}\n// Footer\nctx.fillStyle = \'#907860\';\nctx.font = \'10px Segoe UI, sans-serif\';\nctx.fillText("Generated by Pop\'n Score Tool | " + (DATA.exportedAt || \'\'), 10, totalH - 10);\n// Download (async if avatar needs loading)\nfunction doDownload() {\nvar link = document.createElement(\'a\');\nlink.download = \'popn_class_top50.png\';\nlink.href = canvas.toDataURL(\'image/png\');\nlink.click();\n}\nif (hasAvatar) {\nvar avatarImg = new Image();\navatarImg.onload = function() {\nctx.drawImage(avatarImg, titleRight, 12, avatarSize, avatarSize);\ndoDownload();\n};\navatarImg.onerror = doDownload;\navatarImg.src = chara.imgData;\n} else {\ndoDownload();\n}\n});\n// === Download HTML ===\ndocument.getElementById(\'btnDownloadHtml\').addEventListener(\'click\', function() {\nvar html = \'<!DOCTYPE html>\\n\' + document.documentElement.outerHTML;\nvar blob = new Blob([html], { type: \'text/html\' });\nvar url = URL.createObjectURL(blob);\nvar a = document.createElement(\'a\');\na.href = url;\na.download = \'popn_viewer_\' + new Date().toISOString().slice(0, 10) + \'.html\';\ndocument.body.appendChild(a);\na.click();\ndocument.body.removeChild(a);\nURL.revokeObjectURL(url);\n});\n// === Utility ===\nfunction esc(s) {\nif (!s) return \'\';\nreturn s.replace(/&/g, \'&amp;\').replace(/</g, \'&lt;\').replace(/>/g, \'&gt;\').replace(/"/g, \'&quot;\');\n}\nfunction displayTitle(title, genre) {\nif (!genre || genre === title) return title;\nvar baseTitle = title.replace(/ \\[UPPER\\]$/, \'\');\nif (genre === baseTitle) return title;\nreturn genre + \' / \' + title;\n}\n</script>\n</body>\n</html>'; function openViewer() { var exportData = { player: collectedData.player, scores: collectedData.scores, exportedAt: collectedData.exportedAt, }; log('Opening viewer...'); var html = VIEWER_TEMPLATE.replace('{{DATA_PLACEHOLDER}}', JSON.stringify(exportData)); var blob = new Blob([html], { type: 'text/html' }); var viewUrl = URL.createObjectURL(blob); window.open(viewUrl, '_blank'); log('Viewer opened in new tab'); } createUI(); log("Pop'n Score Tool initialized"); setMsg1('Ready. Click Scrape to start.'); setMsg2(''); setButtonState('idle'); })();